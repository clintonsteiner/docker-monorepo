# Docker image for running Python tests with all dependencies pre-installed
# This image pre-bakes all setup steps to speed up CI/CD test execution

FROM python:3.13-slim

# Set shell options for safety
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# Set working directory
WORKDIR /workspace

# Install system dependencies with apt cache (layer cached for faster builds)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        libkrb5-dev \
        gcc \
        git \
        curl

# Install uv - faster Python package manager (cached)
RUN --mount=type=cache,target=/root/.cache \
    curl -LsSf https://astral.sh/uv/install.sh | sh && \
    mv /root/.local/bin/uv /usr/local/bin/uv

# Create a virtual environment
RUN uv venv /venv
ENV PATH="/venv/bin:$PATH"

# Copy pyproject.toml early for better layer caching
COPY pyproject.toml .

# Install Python dependencies with pip cache
# This caches the dependency layer so tests run immediately
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install -e ".[dev]" && \
    uv pip install \
        pytest-xdist \
        pytest-cov \
        pytest-mock \
        pytest-timeout \
        pyyaml

# Set Python path
ENV PYTHONPATH=/workspace:$PYTHONPATH

# Default command - can be overridden to run tests
CMD ["pytest", "-v", "jenkinsapi_tests"]
