name: Jenkins Update Check

on:
  schedule:
    # Check for updates weekly (Sunday at 2 AM UTC)
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check Jenkins version updates
        id: jenkins-version
        run: |
          echo "Checking Jenkins LTS versions..."

          # Get latest Jenkins LTS version
          LATEST_LTS=$(curl -s https://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/maven-metadata.xml | \
            grep -oP '(?<=<version>)[^<]*lts[^<]*' | tail -1 || echo "unknown")

          CURRENT=$(cat jenkinsapi/JENKINS_VERSION | tr -d '[:space:]')

          echo "Current Jenkins version: $CURRENT"
          echo "Latest Jenkins LTS: $LATEST_LTS"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_LTS" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST_LTS" ] && [ "$LATEST_LTS" != "unknown" ]; then
            echo "jenkins-update-available=true" >> $GITHUB_OUTPUT
          else
            echo "jenkins-update-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Update Jenkins version file
        if: steps.jenkins-version.outputs.jenkins-update-available == 'true'
        run: |
          echo "${{ steps.jenkins-version.outputs.latest }}" > jenkinsapi/JENKINS_VERSION
          echo "Updated jenkinsapi/JENKINS_VERSION to ${{ steps.jenkins-version.outputs.latest }}"

      - name: Check plugin updates
        id: plugins
        working-directory: jenkinsapi
        run: |
          echo "Checking plugin updates..."

          # Count total plugins
          TOTAL_PLUGINS=$(wc -l < plugins.txt)

          # Check for updates and update plugins.txt in-place when newer versions are found.
          TMP_FILE=$(mktemp)
          UPDATES=0

          while IFS= read -r line || [ -n "$line" ]; do
            # Preserve comments/empty lines exactly.
            if [ -z "$line" ] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              echo "$line" >> "$TMP_FILE"
              continue
            fi

            plugin=$(echo "${line%%:*}" | xargs)
            version=$(echo "${line#*:}" | xargs)

            if [ -z "$plugin" ] || [ -z "$version" ]; then
              echo "$line" >> "$TMP_FILE"
              continue
            fi

            latest="$version"

            fetched=$(curl -s -m 5 \
              "https://plugins.jenkins.io/api/plugin/$plugin" 2>/dev/null \
              | grep -o '"version":"[^"]*"' | head -1 | cut -d'"' -f4 || true)

            if [ -n "$fetched" ]; then
              latest="$fetched"
            fi

            if [ "$latest" != "$version" ]; then
              ((UPDATES+=1))
              echo "  $plugin: $version -> $latest"
            fi

            echo "$plugin:$latest" >> "$TMP_FILE"
          done < plugins.txt

          if [ $UPDATES -gt 0 ]; then
            mv "$TMP_FILE" plugins.txt
          else
            rm -f "$TMP_FILE"
          fi

          echo "Total plugins: $TOTAL_PLUGINS"
          echo "Updates available: $UPDATES"
          echo "total-plugins=$TOTAL_PLUGINS" >> $GITHUB_OUTPUT
          echo "updates-available=$UPDATES" >> $GITHUB_OUTPUT

          if [ $UPDATES -gt 0 ]; then
            echo "plugin-update-available=true" >> $GITHUB_OUTPUT
          else
            echo "plugin-update-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for repository changes
        id: changes
        run: |
          if git diff --quiet -- jenkinsapi/JENKINS_VERSION jenkinsapi/plugins.txt; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            git diff --name-only -- jenkinsapi/JENKINS_VERSION jenkinsapi/plugins.txt
          fi

      - name: Create PR for Jenkins updates
        if: steps.changes.outputs.has-changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update jenkinsapi dependencies

            Jenkins: ${{ steps.jenkins-version.outputs.current }} -> ${{ steps.jenkins-version.outputs.latest }}
            Plugin updates: ${{ steps.plugins.outputs.updates-available }}
          branch: chore/jenkinsapi-update-${{ github.run_id }}
          title: "chore: update jenkinsapi dependencies"
          body: |
            ## Jenkins Dependency Updates

            Automated updates detected by the weekly Jenkins check workflow.

            ### Jenkins
            - Current: `${{ steps.jenkins-version.outputs.current }}`
            - Latest: `${{ steps.jenkins-version.outputs.latest }}`
            - Updated in this PR: `${{ steps.jenkins-version.outputs.jenkins-update-available }}`

            ### Plugins
            - Total plugins: `${{ steps.plugins.outputs.total-plugins }}`
            - Updated plugins: `${{ steps.plugins.outputs.updates-available }}`
            - Updated in this PR: `${{ steps.plugins.outputs.plugin-update-available }}`

            This PR updates:
            - `jenkinsapi/JENKINS_VERSION` when a newer Jenkins LTS tag is available
            - `jenkinsapi/plugins.txt` when newer plugin versions are available
          labels: |
            dependencies
            jenkinsapi
          delete-branch: true

      - name: Summary
        if: always()
        run: |
          echo "## Jenkins Update Check Summary"
          echo ""
          echo "Jenkins Version:"
          echo "  Current: ${{ steps.jenkins-version.outputs.current }}"
          echo "  Latest:  ${{ steps.jenkins-version.outputs.latest }}"
          echo "  Update:  ${{ steps.jenkins-version.outputs.jenkins-update-available }}"
          echo ""
          echo "Plugins:"
          echo "  Total:   ${{ steps.plugins.outputs.total-plugins }}"
          echo "  Updates: ${{ steps.plugins.outputs.updates-available }}"
          echo "  Update:  ${{ steps.plugins.outputs.plugin-update-available }}"
          echo ""
          echo "Repository changes: ${{ steps.changes.outputs.has-changes }}"
