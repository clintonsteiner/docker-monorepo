name: caddy-cloudflaredns - Parallel Build & Push

on:
  push:
    branches:
      - master
    paths:
      - 'caddy-cloudflaredns/**'
      - '.github/workflows/caddy-cloudflaredns-build.yml'
  workflow_dispatch:

env:
  DOCKER_USERNAME: clintonsteiner
  DOCKER_CONTAINER_NAME: caddy-cloudflaredns
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.prepare.outputs.tag }}
      should-build: ${{ steps.detect.outputs.should-build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect changes
        id: detect
        run: |
          if git diff HEAD~1 HEAD --name-only | grep -qE '^caddy-cloudflaredns/|\.github/workflows/caddy'; then
            echo "should-build=true" >> $GITHUB_OUTPUT
          else
            echo "should-build=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: prepare
        working-directory: caddy-cloudflaredns
        run: |
          tag=$(grep "^FROM caddy:" Dockerfile | head -1 | sed 's/.*:\([^-]*\).*/\1/')
          echo "tag=$tag" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-build == 'true'
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: latest

      - name: Build test image (amd64 only for speed)
        uses: docker/build-push-action@v6
        with:
          context: ./caddy-cloudflaredns
          platforms: linux/amd64
          push: false
          load: true
          tags: caddy-cloudflaredns:test
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.actor }}/caddy-cloudflaredns:buildcache
          cache-to: type=gha,mode=max

      - name: Run tests (fail fast)
        working-directory: caddy-cloudflaredns
        timeout-minutes: 3
        run: |
          chmod +x test/test-image.sh
          ./test/test-image.sh

  build-amd64:
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: needs.prepare.outputs.should-build == 'true'
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login registries (parallel)
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push amd64
        uses: docker/build-push-action@v6
        with:
          context: ./caddy-cloudflaredns
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-amd64
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-amd64
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.actor }}/caddy-cloudflaredns:buildcache-amd64
          cache-to: type=registry,ref=ghcr.io/${{ github.actor }}/caddy-cloudflaredns:buildcache-amd64,mode=max

  build-arm64:
    runs-on: ubuntu-latest
    needs: [prepare, test]
    if: needs.prepare.outputs.should-build == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for ARM
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Login registries
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push arm64
        uses: docker/build-push-action@v6
        with:
          context: ./caddy-cloudflaredns
          platforms: linux/arm64
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-arm64
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-arm64
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
          cache-from: |
            type=gha
            type=registry,ref=ghcr.io/${{ github.actor }}/caddy-cloudflaredns:buildcache-arm64
          cache-to: type=registry,ref=ghcr.io/${{ github.actor }}/caddy-cloudflaredns:buildcache-arm64,mode=max

  manifest:
    runs-on: ubuntu-latest
    needs: [prepare, build-amd64, build-arm64]
    if: needs.prepare.outputs.should-build == 'true'
    timeout-minutes: 5
    steps:
      - name: Set up Docker CLI
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Create multi-arch manifest
        run: |
          # Docker Hub manifests
          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }} \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}

          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest

          # GHCR manifests
          docker manifest create \
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }} \
            --amend ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-amd64 \
            --amend ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}-arm64
          docker manifest push ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare.outputs.tag }}

          docker manifest create \
            ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest \
            --amend ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64 \
            --amend ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
          docker manifest push ghcr.io/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest

  release:
    runs-on: ubuntu-latest
    needs: [prepare, manifest]
    if: needs.prepare.outputs.should-build == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          draft: false
          prerelease: false
