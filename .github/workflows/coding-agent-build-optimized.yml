name: Coding Agent - Build & Test

on:
  push:
    branches: [master]
    paths:
      - 'coding-agent/**'
      - '.github/workflows/coding-agent-build-optimized.yml'
  pull_request:
    paths:
      - 'coding-agent/**'
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate docker-compose.yml
        run: |
          cd coding-agent
          docker compose config

      - name: Check scripts are executable
        run: |
          cd coding-agent
          test -x scripts/download-model.sh
          test -x test/test-image.sh

  validate-success:
    runs-on: ubuntu-latest
    needs: [test]
    if: always()
    steps:
      - name: Check all jobs succeeded
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: exit 1

      - name: All tests passed
        run: echo "All validation checks passed successfully"
