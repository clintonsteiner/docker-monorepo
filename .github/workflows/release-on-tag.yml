name: Release on Tag

on:
  push:
    tags:
      - 'v*'
      - '*-v*'

permissions:
  contents: write

jobs:
  parse-tag:
    runs-on: ubuntu-latest
    outputs:
      project: ${{ steps.detect.outputs.project }}
      version: ${{ steps.detect.outputs.version }}
      is_valid: ${{ steps.detect.outputs.is_valid }}
    steps:
      - name: Detect project from tag
        id: detect
        run: |
          TAG="${{ github.ref_name }}"
          echo "Tag: $TAG"

          # Parse tag format: project-vX.Y.Z or vX.Y.Z
          if [[ $TAG =~ ^([a-z-]+)-v([0-9.]+)$ ]]; then
            PROJECT="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            echo "Project: $PROJECT, Version: $VERSION"
          elif [[ $TAG =~ ^v([0-9.]+)$ ]]; then
            PROJECT="all"
            VERSION="${BASH_REMATCH[1]}"
            echo "Multi-project release: $VERSION"
          else
            echo "Invalid tag format: $TAG"
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_valid=true" >> $GITHUB_OUTPUT

  test:
    needs: parse-tag
    if: needs.parse-tag.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Run tests for ${{ needs.parse-tag.outputs.project }}
        run: |
          PROJECT="${{ needs.parse-tag.outputs.project }}"
          VERSION="${{ needs.parse-tag.outputs.version }}"

          echo "Testing release: $PROJECT v$VERSION"

          if [ "$PROJECT" = "all" ]; then
            echo "Running all tests..."
            make test-all || exit 1
          else
            echo "Running tests for $PROJECT..."
            make test-$PROJECT || exit 1
          fi

          echo "✓ All tests passed for $PROJECT v$VERSION"

  create-release:
    needs: [parse-tag, test]
    if: needs.parse-tag.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Build release notes
        id: notes
        run: |
          PROJECT="${{ needs.parse-tag.outputs.project }}"
          VERSION="${{ needs.parse-tag.outputs.version }}"
          TAG="${{ github.ref_name }}"
          COMMIT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT:0:7}"

          {
            echo "## Release ${VERSION}"
            echo ""
            if [ "$PROJECT" = "all" ]; then
              echo "Multi-project release"
            else
              echo "Project: **${PROJECT}**"
            fi
            echo ""
            echo "### Build Info"
            echo "- Tag: \`${TAG}\`"
            echo "- Commit: \`${COMMIT_SHORT}\`"
            echo ""
            echo "### Tests"
            echo "✓ All tests passed"
            echo ""
            echo "### Docker Images"
            echo "- \`clintonsteiner/${PROJECT}:${VERSION}\`"
            echo "- \`ghcr.io/clintonsteiner/${PROJECT}:${VERSION}\`"
          } > /tmp/release_notes.md

          cat /tmp/release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aeaaf51615e76
        with:
          tag_name: ${{ github.ref_name }}
          name: >-
            ${{ needs.parse-tag.outputs.project }}-v${{
            needs.parse-tag.outputs.version }}
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: >-
            ${{ contains(needs.parse-tag.outputs.version, 'alpha')
            || contains(needs.parse-tag.outputs.version, 'beta')
            || contains(needs.parse-tag.outputs.version, 'rc') }}

      - name: Summary
        run: |
          {
            echo "## Release Created"
            echo ""
            echo "✓ Tests passed"
            echo "✓ Release published"
            echo ""
            echo "### Details"
            echo "- **Project**: ${{ needs.parse-tag.outputs.project }}"
            echo "- **Version**: ${{ needs.parse-tag.outputs.version }}"
            echo "- **Tag**: ${{ github.ref_name }}"
          } >> $GITHUB_STEP_SUMMARY
