name: caddy-cloudflaredns - Build Once, Push Everywhere

on:
  push:
    branches:
      - master
    paths:
      - 'caddy-cloudflaredns/**'
      - '.github/workflows/caddy-cloudflaredns-build-optimized.yml'
  workflow_dispatch:

env:
  DOCKER_USERNAME: clintonsteiner
  DOCKER_CONTAINER_NAME: caddy-cloudflaredns
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  BUILDKIT_INLINE_CACHE: 1
  REGISTRY: ghcr.io

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Build and test image
        working-directory: caddy-cloudflaredns
        run: |
          echo "Building caddy-cloudflaredns:test..."
          docker build -t caddy-cloudflaredns:test .

          echo "Running tests..."
          chmod +x test/test-image.sh
          ./test/test-image.sh

  build:
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 60
    outputs:
      image-hash: ${{ steps.meta.outputs.image-hash }}
      version-tag: ${{ steps.meta.outputs.version-tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to registries
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.repository_owner }} --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

      - name: Generate image metadata
        id: meta
        run: |
          HASH=$(git rev-parse --short HEAD)
          VERSION=$(cat caddy-cloudflaredns/VERSION)
          echo "image-hash=${HASH}" >> $GITHUB_OUTPUT
          echo "version-tag=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build & Push multi-arch
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: ./caddy-cloudflaredns
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ steps.meta.outputs.image-hash }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ steps.meta.outputs.version-tag }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:stable
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ steps.meta.outputs.image-hash }}
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ steps.meta.outputs.version-tag }}
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:stable
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache,mode=max

  release:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.build.outputs.version-tag }}
          draft: false
          prerelease: false
          body: |
            - Hash: ${{ needs.build.outputs.image-hash }}
            - Built with: linux/amd64, linux/arm64
            - Tags: hash, version, latest, stable
