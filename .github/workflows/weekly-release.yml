name: Weekly Release - Trigger Builds

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: weekly-release
  cancel-in-progress: true

jobs:
  get-versions:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      caddy_version: ${{ steps.versions.outputs.caddy_version }}
      jenkins_version: ${{ steps.versions.outputs.jenkins_version }}
      ollama_version: ${{ steps.versions.outputs.ollama_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Extract current versions
        id: versions
        run: |
          caddy_version=$(cat caddy-cloudflaredns/VERSION | tr -d '[:space:]')
          echo "caddy_version=$caddy_version" >> $GITHUB_OUTPUT

          jenkins_version=$(cat jenkinsapi/JENKINS_VERSION | tr -d '[:space:]')
          echo "jenkins_version=$jenkins_version" >> $GITHUB_OUTPUT

          ollama_version=$(cat ollama/VERSION | tr -d '[:space:]')
          echo "ollama_version=$ollama_version" >> $GITHUB_OUTPUT

          echo "Current versions:"
          echo "  Caddy: $caddy_version"
          echo "  Jenkins: $jenkins_version"
          echo "  Ollama: $ollama_version"

  trigger-builds:
    needs: get-versions
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Trigger caddy build
        run: |
          gh workflow run caddy-cloudflaredns-build-optimized.yml \
            --repo ${{ github.repository }} \
            --ref master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger jenkins build
        run: |
          gh workflow run jenkinsapi-build-optimized.yml \
            --repo ${{ github.repository }} \
            --ref master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger ollama build
        run: |
          gh workflow run ollama-build-optimized.yml \
            --repo ${{ github.repository }} \
            --ref master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          {
            echo "## Weekly Release"
            echo ""
            echo "âœ“ Build workflows triggered"
            echo ""
            echo "### Current Versions"
            echo "- Caddy: ${{ needs.get-versions.outputs.caddy_version }}"
            echo "- Jenkins: ${{ needs.get-versions.outputs.jenkins_version }}"
            echo "- Ollama: ${{ needs.get-versions.outputs.ollama_version }}"
            echo ""
            echo "Version updates are managed by version-check.yml"
          } >> $GITHUB_STEP_SUMMARY
