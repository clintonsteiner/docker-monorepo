name: Weekly Release - Auto Increment Minor Versions

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  increment-versions:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has_changes: ${{ steps.detect.outputs.has_changes }}
      caddy_version: ${{ steps.versions.outputs.caddy_version }}
      jenkins_version: ${{ steps.versions.outputs.jenkins_version }}
      ollama_version: ${{ steps.versions.outputs.ollama_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Increment and update versions
        id: versions
        shell: bash
        run: |
          #!/bin/bash
          set -euo pipefail

          # Extract and increment version for caddy
          caddy_current=$(grep "^FROM caddy:" \
            caddy-cloudflaredns/Dockerfile | head -1 | \
            sed 's/.*:\([^-]*\).*/\1/')
          IFS='.' read -r maj min patch <<< "$caddy_current"
          caddy_new="$maj.$((min + 1)).0"
          sed -i "s|FROM caddy:.*-builder|FROM caddy:${caddy_new}-builder|" \
            caddy-cloudflaredns/Dockerfile
          sed -i "0,/FROM caddy:[0-9.]*/s||FROM caddy:${caddy_new}|" \
            caddy-cloudflaredns/Dockerfile
          echo "caddy_version=$caddy_new" >> $GITHUB_OUTPUT

          # Extract and increment version for jenkins
          jenkins_current=$(cat jenkinsapi/JENKINS_VERSION | tr -d '\n')
          if [[ $jenkins_current =~ ^lts-jdk([0-9]+)$ ]]; then
            jenkins_new="lts-jdk$((${BASH_REMATCH[1]} + 1))"
          else
            jenkins_new="$jenkins_current"
          fi
          echo "$jenkins_new" > jenkinsapi/JENKINS_VERSION
          echo "jenkins_version=$jenkins_new" >> $GITHUB_OUTPUT

          # Extract and increment version for ollama
          ollama_current=$(grep "^FROM" ollama/Dockerfile | head -1 | \
            awk '{print $2}' | sed 's/.*://g')
          IFS='.' read -r maj min patch <<< "$ollama_current"
          ollama_new="$maj.$((min + 1)).0"
          echo "ollama_version=$ollama_new" >> $GITHUB_OUTPUT

          echo "New versions:"
          echo "  Caddy: $caddy_new"
          echo "  Jenkins: $jenkins_new"
          echo "  Ollama: $ollama_new"

      - name: Detect changes
        id: detect
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --stat
          fi

      - name: Commit and push changes
        if: steps.detect.outputs.has_changes == 'true'
        shell: bash
        run: |
          git add caddy-cloudflaredns/Dockerfile jenkinsapi/JENKINS_VERSION
          cat > /tmp/commit_msg.txt << 'EOF'
          chore: weekly release - increment minor versions

          caddy: ${{ steps.versions.outputs.caddy_version }}
          jenkins: ${{ steps.versions.outputs.jenkins_version }}
          ollama: ${{ steps.versions.outputs.ollama_version }}
          EOF
          git commit -F /tmp/commit_msg.txt
          git push origin master

  wait-for-builds:
    needs: increment-versions
    if: needs.increment-versions.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Wait for builds
        uses: actions/github-script@7d8c85880fbf4ef596ebc10c45e05050e5ee23aee
        with:
          script: |
            const repo = context.repo;
            const { data: commit } = await github.rest.repos.getCommit({
              owner: repo.owner,
              repo: repo.repo,
              ref: 'master'
            });

            const sha = commit.sha;
            console.log(`Waiting for builds for ${sha}`);

            let attempts = 0;
            const maxAttempts = 60;

            while (attempts < maxAttempts) {
              const { data: runs } = await github.rest
                .actions.listWorkflowRunsForRepo({
                  owner: repo.owner,
                  repo: repo.repo,
                  head_sha: sha,
                  exclude_pull_requests: true
                });

              const buildRuns = runs.workflow_runs.filter(
                r => r.id !== context.runId &&
                  (r.name.includes('Build') ||
                   r.name.includes('build'))
              );

              if (buildRuns.length > 0) {
                const done = buildRuns.filter(
                  r => r.status === 'completed'
                );
                console.log(
                  `${done.length}/${buildRuns.length} builds complete`
                );

                if (done.length === buildRuns.length) {
                  console.log('✓ All builds complete');
                  break;
                }
              }

              await new Promise(r => setTimeout(r, 30000));
              attempts++;
            }

      - name: Summary
        run: |
          {
            echo "## Weekly Release"
            echo ""
            echo "✓ Versions incremented and pushed"
            echo ""
            echo "### New Versions"
            echo "- Caddy: \
              ${{ needs.increment-versions.outputs.caddy_version }}"
            echo "- Jenkins: \
              ${{ needs.increment-versions.outputs.jenkins_version }}"
            echo "- Ollama: \
              ${{ needs.increment-versions.outputs.ollama_version }}"
          } >> $GITHUB_STEP_SUMMARY
