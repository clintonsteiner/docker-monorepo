name: jenkinsapi - Build Once, Push Everywhere

on:
  push:
    branches:
      - master
    paths:
      - 'jenkinsapi/**'
      - '.github/workflows/jenkinsapi-build-optimized.yml'
  workflow_dispatch:

env:
  DOCKER_USERNAME: clintonsteiner
  DOCKER_CONTAINER_NAME: jenkinsapi
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  BUILDKIT_INLINE_CACHE: 1
  REGISTRY: ghcr.io

jobs:
  prepare-tags:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      image-hash: ${{ steps.tags.outputs.image-hash }}
      version-tag: ${{ steps.tags.outputs.version-tag }}
      cache-tag: ${{ steps.tags.outputs.cache-tag }}
      should-build: ${{ steps.detect.outputs.should-build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Detect changes
        id: detect
        run: |
          # Paths filter already ensures this workflow only triggers on relevant changes
          # Always build if workflow is triggered (paths filter is the safeguard)
          echo "should-build=true" >> $GITHUB_OUTPUT

      - name: Generate tags
        id: tags
        run: |
          HASH=$(git rev-parse --short HEAD)
          echo "image-hash=${HASH}" >> $GITHUB_OUTPUT

          # Extract Jenkins version from Dockerfile
          VERSION=$(grep "^FROM jenkins/jenkins:" jenkinsapi/Dockerfile | head -1 | sed 's/.*:\([^-]*\).*/\1/')
          echo "version-tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "cache-tag=buildcache" >> $GITHUB_OUTPUT

  test:
    runs-on: ubuntu-latest
    needs: prepare-tags
    if: needs.prepare-tags.outputs.should-build == 'true'
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Build and test image
        working-directory: jenkinsapi
        timeout-minutes: 5
        run: |
          echo "Building jenkinsapi:test..."
          docker build -t jenkinsapi:test .

          echo "Running tests..."
          # Quick verification tests
          echo "Verifying Jenkins binary..."
          docker run --rm jenkinsapi:test test -x /usr/local/bin/jenkins.sh

          echo "Verifying Jenkins version..."
          docker run --rm jenkinsapi:test /usr/local/bin/jenkins.sh --version

          echo "Verifying entrypoint..."
          docker run --rm jenkinsapi:test test -x /usr/local/bin/jenkins-entrypoint.sh

          echo "Verifying utilities..."
          docker run --rm jenkinsapi:test which curl ping

          echo " All tests passed"

  build-amd64:
    runs-on: ubuntu-latest
    needs: [prepare-tags, test]
    if: needs.prepare-tags.outputs.should-build == 'true'
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registries
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

      - name: Build & Push amd64 (by digest, no manifest lists)
        id: build-amd64
        uses: docker/build-push-action@v6
        with:
          context: ./jenkinsapi
          platforms: linux/amd64
          push: true
          outputs: type=image,push-by-digest=true,name-canonical=true
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache-amd64
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache-amd64,mode=max

      - name: Tag amd64 by digest
        env:
          DIGEST: ${{ steps.build-amd64.outputs.digest }}
          HASH_TAG: ${{ needs.prepare-tags.outputs.image-hash }}
          VERSION_TAG: ${{ needs.prepare-tags.outputs.version-tag }}
        run: |
          set -x
          for tag in "${HASH_TAG}" "${VERSION_TAG}" "latest" "stable"; do
            docker tag "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}@${DIGEST}" \
              "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-amd64"
            docker push "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-amd64"

            docker tag "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}@${DIGEST}" \
              "${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-amd64"
            docker push "${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-amd64"
          done

  build-arm64:
    runs-on: ubuntu-latest
    needs: [prepare-tags, test]
    if: needs.prepare-tags.outputs.should-build == 'true'
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Login to registries
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

      - name: Build & Push arm64 (by digest, no manifest lists)
        id: build-arm64
        uses: docker/build-push-action@v6
        with:
          context: ./jenkinsapi
          platforms: linux/arm64
          push: true
          outputs: type=image,push-by-digest=true,name-canonical=true
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache-arm64
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:buildcache-arm64,mode=max

      - name: Tag arm64 by digest
        env:
          DIGEST: ${{ steps.build-arm64.outputs.digest }}
          HASH_TAG: ${{ needs.prepare-tags.outputs.image-hash }}
          VERSION_TAG: ${{ needs.prepare-tags.outputs.version-tag }}
        run: |
          set -x
          for tag in "${HASH_TAG}" "${VERSION_TAG}" "latest" "stable"; do
            docker tag "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}@${DIGEST}" \
              "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-arm64"
            docker push "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-arm64"

            docker tag "${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}@${DIGEST}" \
              "${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-arm64"
            docker push "${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${tag}-arm64"
          done

  manifest:
    runs-on: ubuntu-latest
    needs: [prepare-tags, test, build-amd64, build-arm64]
    if: needs.prepare-tags.outputs.should-build == 'true'
    timeout-minutes: 5
    steps:
      - name: Set up Docker CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ env.DOCKER_USERNAME }} --password-stdin

      - name: Create multi-arch manifests (reuse built images, no rebuild)
        run: |
          # Use prebuilt images - no rebuild needed

          # Hash tag manifest
          docker manifest create \
            ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }} \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}-amd64 \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}-arm64
          docker manifest push ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}

          # Version tag manifest
          docker manifest create \
            ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }} \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}-amd64 \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}-arm64
          docker manifest push ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}

          # Latest tag manifest
          docker manifest create \
            ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64 \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
          docker manifest push ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:latest

          # Stable tag manifest
          docker manifest create \
            ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:stable \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:stable-amd64 \
            --amend ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:stable-arm64
          docker manifest push ${{ env.REGISTRY }}/${{ github.actor }}/${{ env.DOCKER_CONTAINER_NAME }}:stable

          # Repeat for Docker Hub
          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }} \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.image-hash }}

          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }} \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:${{ needs.prepare-tags.outputs.version-tag }}

          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:latest

          docker manifest create \
            ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:stable \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:stable-amd64 \
            --amend ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:stable-arm64
          docker manifest push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_CONTAINER_NAME }}:stable

  release:
    runs-on: ubuntu-latest
    needs: [prepare-tags, manifest]
    if: needs.prepare-tags.outputs.should-build == 'true'
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Create Release (no rebuild, just metadata)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-tags.outputs.version-tag }}
          draft: false
          prerelease: false
          body: |
            - Hash: ${{ needs.prepare-tags.outputs.image-hash }}
            - Built with: parallel amd64 + arm64 builds
            - Tags: hash, version, latest, stable
